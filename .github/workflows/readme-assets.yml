name: README Assets (snake + streak)

on:
  schedule:
    # Daily at 08:10 UTC
    - cron: "10 8 * * *"
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Prepare output directory
        run: |
          rm -rf dist
          mkdir -p dist

      - name: Generate contribution snake SVGs
        uses: Platane/snk@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/github-contribution-grid-snake.svg
            dist/github-contribution-grid-snake-dark.svg?palette=github-dark
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch streak SVGs (with fallback)
        env:
          USERNAME: ${{ github.repository_owner }}
        run: |
          set -euo pipefail

          OUT="dist/github-streak.svg"
          OUT_DARK="dist/github-streak-dark.svg"

          URL1="https://streak-stats.demolab.com/?user=${USERNAME}&theme=radical"
          URL2="https://github-readme-streak-stats.herokuapp.com/?user=${USERNAME}&theme=radical"

          fetch_and_validate () {
            local url="$1"
            local out="$2"

            echo "Fetching: ${url}"
            curl -fsSL --retry 5 --retry-all-errors --connect-timeout 10 --max-time 30 "${url}" -o "${out}"

            # Basic validation: file exists, non-trivial size, contains <svg, and does not look like an error page.
            test -s "${out}"
            test "$(wc -c < "${out}")" -gt 2000
            grep -q "<svg" "${out}"
            ! grep -qi "internal server error" "${out}"
            ! grep -qi "<title>500" "${out}"
          }

          rm -f "${OUT}"
          (fetch_and_validate "${URL1}" "${OUT}") || (fetch_and_validate "${URL2}" "${OUT}")

          # Keep a separate dark filename for GitHub's `#gh-dark-mode-only` routing
          cp "${OUT}" "${OUT_DARK}"

      - name: Publish all assets to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
          commit_message: "chore: update README assets"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
